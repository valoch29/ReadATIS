name: Format ATIS FMS complet avec METAR

on:
  workflow_dispatch:
  schedule:
    - cron: '25,55 * * * *'  # toutes les 30 minutes

jobs:
  format-atis-fms:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Installer Python et dépendances
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y python3 python3-pip
          pip install requests

      - name: Générer ATIS format FMS complet
        env:
          METAR_API_TOKEN: ${{ secrets.METAR_API_TOKEN }}
        run: |
          python3 <<'PYCODE'
          import re, os, requests

          input_file = "atis_tallinn.txt"
          output_file = "atis_tallinn_fms.txt"

          if not os.path.exists(input_file):
              print(f"⚠️ Fichier {input_file} introuvable")
              exit(1)

          with open(input_file, "r", encoding="utf-8") as f:
              raw = f.read().lower()

          # --- Mapping phonétique ATIS letter ---
          phonetic_map = {
              "alpha":"A", "bravo":"B", "charlie":"C", "delta":"D", "echo":"E",
              "foxtrot":"F", "golf":"G", "hotel":"H", "india":"I", "juliet":"J",
              "kilo":"K", "lima":"L", "mike":"M", "november":"N", "oscar":"O",
              "papa":"P", "quebec":"Q", "romeo":"R", "sierra":"S", "tango":"T",
              "uniform":"U", "victor":"V", "whiskey":"W", "x-ray":"X", "yankee":"Y", "zulu":"Z"
          }

          def extract(pattern, text, default="XXX"):
              match = re.search(pattern, text, re.IGNORECASE)
              return match.group(1).strip() if match else default

          def words_to_number(s):
              """Convertit les nombres écrits en lettres en chiffres"""
              mapping = {
                  "zero":"0","one":"1","two":"2","three":"3","four":"4","five":"5",
                  "six":"6","seven":"7","eight":"8","nine":"9"
              }
              for word, digit in mapping.items():
                  s = re.sub(r"\b"+word+r"\b", digit, s)
              return re.sub(r"\s+","",s)

          def fetch_metar():
              token = os.environ.get("METAR_API_TOKEN")
              if not token:
                  return {}
              try:
                  url = f"https://avwx.rest/api/metar/EETN?options=info&format=json&token={token}"
                  r = requests.get(url, timeout=10)
                  if r.status_code == 200:
                      data = r.json()
                      return {
                          "wind_dir": int(data.get("wind_direction", {}).get("value", 0)),
                          "wind_speed": int(data.get("wind_speed", {}).get("value", 0)),
                          "visibility": int(data.get("visibility", {}).get("value", 0)),
                          "altimeter": int(data.get("altimeter", {}).get("value", 0)),
                          "temperature": float(data.get("temperature", {}).get("value", 0)),
                          "dewpoint": float(data.get("dewpoint", {}).get("value", 0))
                      }
              except:
                  return {}
              return {}

          def validate(data, metar):
              try:
                  if metar:
                      # Vent
                      if data["wind"] != "XXX":
                          dir_deg, speed = map(int, re.findall(r"\d+", data["wind"]))
                          if abs(dir_deg - metar["wind_dir"]) > 20 or abs(speed - metar["wind_speed"]) > 10:
                              data["wind"]="XXX"
                      # Visibilité
                      if data["visibility"] != "XXX":
                          vis = int(re.findall(r"\d+", data["visibility"])[0])
                          if abs(vis - metar["visibility"]) > 2:
                              data["visibility"]="XXX"
                      # Temp/Dew
                      if data["temperature"] != "XXX":
                          at, dp = int(data["temperature"]), int(data["dewpoint"])
                          if abs(at - metar["temperature"]) > 3 or abs(dp - metar["dewpoint"]) > 3:
                              data["temperature"]="XXX"; data["dewpoint"]="XXX"
                      # QNH
                      if data["qnh"] != "XXX":
                          if abs(int(data["qnh"]) - metar["altimeter"]) > 5:
                              data["qnh"]="XXX"
              except:
                  for key in ["wind","visibility","temperature","dewpoint","qnh"]:
                      data[key]="XXX"
              return data

          # --- Extraire valeurs ---
          atis_letter_word = extract(r"information\s+([a-zA-Z\-]+)", raw, "XXX").lower()
          atis_letter = phonetic_map.get(atis_letter_word, "XXX")

          atis_time_word = extract(r"time\s+([a-z\s]+)", raw, "XXX")
          atis_time = words_to_number(atis_time_word) if atis_time_word != "XXX" else "XXX"

          # Vent : chercher pattern "(\d+ degrees) (\d+ knots)"
          wind_match = re.search(r"(\d{1,3})\s*degrees.*?(\d{1,2})\s*knots", raw)
          wind = f"{wind_match.group(1)}°{wind_match.group(2)}KT" if wind_match else "XXX"

          # Visibilité en km
          vis_match = re.search(r"visibility.*?(\d+)", raw)
          visibility = f"{vis_match.group(1)}KM" if vis_match else "XXX"

          # Nuages
          cloud_matches = re.findall(r"(overcast|broken|few|scattered|bkn|sct|ovc)[ ,]*(\d+)[ ]*feet", raw)
          clouds = " ".join([f"{m[0].upper()} {m[1]}" for m in cloud_matches]) if cloud_matches else "XXX"

          # RWY
          runway = extract(r"runway\s+(\d+)", raw)

          # RWY Condition
          rwy_cond_match = re.search(r"touchdown.*?(\d+)[^\d]+midpoint.*?(\d+)[^\d]+stop end.*?(\d+)", raw)
          rwy_cond = f"TDZ {rwy_cond_match.group(1)}/MID {rwy_cond_match.group(2)}/END {rwy_cond_match.group(3)}" if rwy_cond_match else "XXX"

          # Temp/Dew
          temperature = extract(r"temperature[, ]+(\d+)", raw)
          dewpoint = extract(r"dew point[, ]+(\d+)", raw)

          # QNH
          qnh = extract(r"qnh[, ]?(\d{3,4})", raw)

          # --- Validation METAR ---
          metar_data = fetch_metar()
          data = {"wind": wind, "visibility": visibility, "temperature": temperature,
                  "dewpoint": dewpoint, "qnh": qnh}
          data = validate(data, metar_data)

          # --- Construire message FMS ---
          fms_text = (
              f"EETN ATIS INFO {atis_letter} {atis_time}Z. "
              f"{data['wind']} {data['visibility']} {clouds} "
              f"RWY {runway} IN USE. "
          )
          if rwy_cond != "XXX":
              fms_text += f"RWY COND {rwy_cond}. "
          fms_text += f"TEMP {data['temperature']}/{data['dewpoint']}C. "
          fms_text += f"A{data['qnh']}."

          with open(output_file, "w", encoding="utf-8") as f:
              f.write(fms_text + "\n")

          print("✅ ATIS FMS complet généré :", output_file)
          print(fms_text)
          PYCODE
