name: Format ATIS FMS

on:
  workflow_dispatch:
  schedule:
    - cron: '25,55 * * * *'  # toutes les 30 minutes, ajustable

jobs:
  format-atis-fms:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Installer Python et dépendances
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y python3 python3-pip
          pip install requests

      - name: Générer ATIS format FMS
        run: |
          python3 <<'PYCODE'
          import re
          import os
          import sys
          from datetime import datetime

          input_file = "atis_tallinn.txt"
          output_file = "atis_tallinn_fms.txt"

          if not os.path.exists(input_file):
              print(f"⚠️ Fichier {input_file} introuvable")
              sys.exit(1)

          with open(input_file, "r", encoding="utf-8") as f:
              raw = f.read()

          # Fonctions utilitaires
          def extract(pattern, text, default="XXX"):
              match = re.search(pattern, text, re.IGNORECASE)
              return match.group(1).strip() if match else default

          def extract_float(pattern, text, default="XXX"):
              match = re.search(pattern, text, re.IGNORECASE)
              return f"{float(match.group(1)):.0f}" if match else default

          # Extraire données ATIS
          atis_letter = extract(r"[iI]nformation\s+([A-Z])", raw)
          atis_time = extract(r"[tT]ime\s+(\d{3,4})", raw)

          # Vent
          wind_dir = extract(r"[wW]ind.*?(\d{1,3})\s*degrees", raw)
          wind_speed = extract(r"[wW]ind.*?(\d{1,3})\s*knots", raw)
          wind = f"{wind_dir}°{wind_speed}KT" if wind_dir != "XXX" and wind_speed != "XXX" else "XXX"

          # Visibilité en km
          visibility = extract(r"[vV]isibility.*?(\d+)\s*(?:km|kilometers|metres|litres)", raw)
          visibility = f"{visibility}KM" if visibility != "XXX" else "XXX"

          # Nuages
          cloud_matches = re.findall(r"(overcast|scatter|few|broken)[ ,]*(\d+)[ ]*feet", raw, re.IGNORECASE)
          clouds = " ".join([f"{m[0].upper()} {m[1]}" for m in cloud_matches]) if cloud_matches else "XXX"

          # RWY et condition
          runway = extract(r"[rR]unway\s+(\d+)", raw)
          rwy_cond_match = re.search(r"touchdown.*?(\d+)[^\d]+midpoint.*?(\d+)[^\d]+stop end.*?(\d+)", raw, re.IGNORECASE)
          rwy_cond = f"TDZ {rwy_cond_match.group(1)}/MID {rwy_cond_match.group(2)}/END {rwy_cond_match.group(3)}" if rwy_cond_match else "XXX"

          # Temp / Dew
          temperature = extract(r"[tT]emperature[, ]+(\d+)", raw)
          dewpoint = extract(r"[dD]ew point[, ]+(\d+)", raw)

          # QNH
          qnh = extract(r"[qQ][nN][hH][ ,]?(\d{3,4})", raw)

          # Construire message FMS
          fms_text = (
              f"EETN ATIS INFO {atis_letter} {atis_time}Z. "
              f"{wind} {visibility} {clouds} "
              f"RWY {runway} IN USE. "
          )
          if rwy_cond != "XXX":
              fms_text += f"RWY COND {rwy_cond}. "
          fms_text += f"TEMP {temperature}/{dewpoint}C. "
          fms_text += f"A{qnh}. "

          # Sauvegarde
          with open(output_file, "w", encoding="utf-8") as f:
              f.write(fms_text + "\n")

          print("✅ ATIS format FMS généré : ", output_file)
          print(fms_text)
          PYCODE
