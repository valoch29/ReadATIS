name: Format ATIS pour FMS

on:
  workflow_dispatch:
  schedule:
    - cron: '23,53 * * * *'  # juste après l'enregistrement/transcription

jobs:
  format-atis:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Installer Python
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y python3 python3-pip

      - name: Formater ATIS en style FMS
        run: |
          python3 <<'PYCODE'
          import re
          from datetime import datetime

          input_file = "atis_tallinn.txt"
          output_file = "atis_tallinn_fms.txt"

          with open(input_file, "r", encoding="utf-8") as f:
              text = f.read()

          # 1️⃣ Extraire info principale (simplifié)
          match_info = re.search(r"[iI]nformation\s+([A-Z])", text)
          atis_letter = match_info.group(1) if match_info else "X"

          match_time = re.search(r"[tT]ime\s+(\d{3,4})", text)
          atis_time = match_time.group(1) if match_time else "0000"

          match_wind = re.search(r"[wW]ind.*?(\d{1,3})\s*degrees[,/ ]+(\d+)\s*knots", text)
          wind = f"{match_wind.group(1).zfill(3)}{match_wind.group(2).zfill(2)}KT" if match_wind else "00000KT"

          match_vis = re.search(r"[vV]isibility.*?(\d+)\s*kilometers?", text)
          visibility = f"{int(match_vis.group(1))*0.539957:.0f}SM" if match_vis else "10SM"

          # Exemple très simple pour clouds
          cloud_matches = re.findall(r"(overcast|broken|scattered|few)[ ,]*(\d+)", text, re.IGNORECASE)
          clouds = " ".join([f"{m[1]}{m[0][:2].upper()}" for m in cloud_matches]) if cloud_matches else ""

          # Runway in use
          match_rwy = re.search(r"[rR]unway\s+(\d+)", text)
          runway = match_rwy.group(1) if match_rwy else "XX"

          # Mettre tout ensemble style FMS
          fms_text = (
              f"EETN ATIS INFO {atis_letter} {atis_time}Z. "
              f"{wind} {visibility} {clouds} "
              f"RWY {runway} IN USE. "
              "ADVS YOU HAVE INFO {atis_letter}."
          )

          with open(output_file, "w", encoding="utf-8") as f:
              f.write(fms_text + "\n")

          print("✅ ATIS formaté style FMS :")
          print(fms_text)
          PYCODE

      - name: Commit et push ATIS FMS
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add atis_tallinn_fms.txt
          git commit -m "Mise à jour ATIS format FMS ($(date +'%Y-%m-%d %H:%M'))" || echo "Rien à commit"
          git push
