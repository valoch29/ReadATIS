name: Format ATIS FMS complet avec METAR

on:
  workflow_dispatch:
  schedule:
    - cron: '25,55 * * * *'  # toutes les 30 minutes

jobs:
  format-atis-fms:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Installer Python et dépendances
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y python3 python3-pip
          pip install requests

      - name: Générer ATIS format FMS complet
        env:
          METAR_API_TOKEN: ${{ secrets.METAR_API_TOKEN }}
        run: |
          python3 <<'PYCODE'
          import re, os, sys, requests

          input_file = "atis_tallinn.txt"
          output_file = "atis_tallinn_fms.txt"

          if not os.path.exists(input_file):
              print(f"⚠️ Fichier {input_file} introuvable")
              sys.exit(1)

          with open(input_file, "r", encoding="utf-8") as f:
              raw = f.read()

          def extract(pattern, text, default="XXX"):
              match = re.search(pattern, text, re.IGNORECASE)
              return match.group(1).strip() if match else default

          def fetch_metar():
              token = os.environ.get("METAR_API_TOKEN")
              if not token:
                  print("⚠️ METAR_API_TOKEN non défini, validation désactivée")
                  return {}
              try:
                  url = f"https://avwx.rest/api/metar/EETN?options=info&format=json&token={token}"
                  r = requests.get(url, timeout=10)
                  if r.status_code == 200:
                      data = r.json()
                      return {
                          "wind_dir": int(data.get("wind_direction", {}).get("value", 0)),
                          "wind_speed": int(data.get("wind_speed", {}).get("value", 0)),
                          "visibility": int(data.get("visibility", {}).get("value", 0)),
                          "altimeter": int(data.get("altimeter", {}).get("value", 0)),
                          "temperature": float(data.get("temperature", {}).get("value", 0)),
                          "dewpoint": float(data.get("dewpoint", {}).get("value", 0))
                      }
              except Exception as e:
                  print(f"⚠️ Erreur récupération METAR: {e}")
              return {}

          def validate(data, metar):
              try:
                  if data["wind"] != "XXX" and metar:
                      dir_speed = re.findall(r"\d+", data["wind"])
                      if len(dir_speed) == 2:
                          dir_deg, speed = map(int, dir_speed)
                          if abs(dir_deg - metar["wind_dir"]) > 20 or abs(speed - metar["wind_speed"]) > 10:
                              data["wind"]="XXX"
                  if data["visibility"] != "XXX" and metar:
                      vis = int(re.findall(r"\d+", data["visibility"])[0])
                      if abs(vis - metar["visibility"]) > 2:
                          data["visibility"]="XXX"
                  if data["temperature"] != "XXX" and metar:
                      at = int(data["temperature"])
                      dp = int(data["dewpoint"])
                      if abs(at - metar["temperature"]) > 3 or abs(dp - metar["dewpoint"]) > 3:
                          data["temperature"]="XXX"; data["dewpoint"]="XXX"
                  if data["qnh"] != "XXX" and metar:
                      if abs(int(data["qnh"]) - metar["altimeter"]) > 5:
                          data["qnh"]="XXX"
              except:
                  for key in ["wind","visibility","temperature","dewpoint","qnh"]:
                      data[key]="XXX"
              return data

          # --- Extraire données ATIS ---
          atis_letter = extract(r"[iI]nformation\s+([A-Z])", raw)
          atis_time = extract(r"[tT]ime\s+(\d{3,4})", raw)
          wind_dir = extract(r"[wW]ind.*?(\d{1,3})\s*degrees", raw)
          wind_speed = extract(r"[wW]ind.*?(\d{1,3})\s*knots", raw)
          wind = f"{wind_dir}°{wind_speed}KT" if wind_dir!="XXX" and wind_speed!="XXX" else "XXX"
          visibility = extract(r"[vV]isibility.*?(\d+)\s*(?:km|kilometers|metres|litres)", raw)
          visibility = f"{visibility}KM" if visibility!="XXX" else "XXX"
          cloud_matches = re.findall(r"(overcast|broken|few|scattered|bkn|sct|ovc)[ ,]*(\d+)[ ]*feet", raw, re.IGNORECASE)
          clouds = " ".join([f"{m[0].upper()} {m[1]}" for m in cloud_matches]) if cloud_matches else "XXX"
          runway = extract(r"[rR]unway\s+(\d+)", raw)
          rwy_cond_match = re.search(r"touchdown.*?(\d+)[^\d]+midpoint.*?(\d+)[^\d]+stop end.*?(\d+)", raw, re.IGNORECASE)
          rwy_cond = f"TDZ {rwy_cond_match.group(1)}/MID {rwy_cond_match.group(2)}/END {rwy_cond_match.group(3)}" if rwy_cond_match else "XXX"
          temperature = extract(r"[tT]emperature[, ]+(\d+)", raw)
          dewpoint = extract(r"[dD]ew point[, ]+(\d+)", raw)
          qnh = extract(r"[qQ][nN][hH][ ,]?(\d{3,4})", raw)

          metar_data = fetch_metar()
          data = {
              "wind": wind,
              "visibility": visibility,
              "temperature": temperature,
              "dewpoint": dewpoint,
              "qnh": qnh
          }
          data = validate(data, metar_data)

          fms_text = (
              f"EETN ATIS INFO {atis_letter} {atis_time}Z. "
              f"{data['wind']} {data['visibility']} {clouds} "
              f"RWY {runway} IN USE. "
          )
          if rwy_cond!="XXX":
              fms_text += f"RWY COND {rwy_cond}. "
          fms_text += f"TEMP {data['temperature']}/{data['dewpoint']}C. "
          fms_text += f"A{data['qnh']}. "

          # Écrasement du fichier garanti
          with open(output_file, "w", encoding="utf-8") as f:
              f.write(fms_text + "\n")

          print("✅ ATIS FMS complet généré :", output_file)
          print(fms_text)
          PYCODE

      - name: Commit et push ATIS FMS
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add atis_tallinn_fms.txt
          git commit -m "Mise à jour ATIS FMS ($(date +'%Y-%m-%d %H:%M'))" || echo "Rien à commit"
          git push
