name: 1_enregistrement_atis

on:
  schedule:
    - cron: "22,52 * * * *"
  workflow_dispatch:

jobs:
  record_atis:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      # -----------------------------
      # 1. Checkout
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------
      # 2. Install ffmpeg + curl
      # -----------------------------
      - name: Installer ffmpeg et curl
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y ffmpeg curl

      # -----------------------------
      # 3. Record ATIS stream
      # -----------------------------
      - name: Enregistrer le flux ATIS en MP3 (120 sec)
        run: |
          echo "üéô Enregistrement du flux LiveATC pour 120 secondes..."
          curl -s -A "Mozilla/5.0" -e "https://www.liveatc.net/" \
            "https://s1-fmt2.liveatc.net/eetn2_atis" \
          | ffmpeg -hide_banner -loglevel error -i pipe:0 -t 120 -y atis_recorded.mp3

          echo "Dur√©e MP3 :"
          ffmpeg -i atis_recorded.mp3 2>&1 | grep "Duration"

      # -----------------------------
      # 4. Convert MP3 ‚Üí WAV
      # -----------------------------
      - name: Convertir MP3 en WAV mono 16kHz
        run: |
          ffmpeg -y -i atis_recorded.mp3 -ac 1 -ar 16000 atis_recorded.wav

          echo "Dur√©e WAV :"
          ffmpeg -i atis_recorded.wav 2>&1 | grep "Duration"

      # -----------------------------
      # 5. Validate audio duration
      # -----------------------------
      - name: V√©rifier la dur√©e audio minimale
        run: |
          DURATION=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 atis_recorded.wav)
          echo "Dur√©e d√©tect√©e : $DURATION sec"

          # Fail if file is too short (< 100 sec) ‚Üí indicates truncated LiveATC stream
          if (( $(echo "$DURATION < 100" | bc -l) )); then
            echo "‚ùå Fichier trop court ‚Üí enregistrement incomplet"
            exit 1
          fi

      # -----------------------------
      # 6. Commit & push only if changed
      # -----------------------------
      - name: Commit et push du fichier audio
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add atis_recorded.mp3 atis_recorded.wav
          git commit -m "Mise √† jour de l‚Äôaudio ATIS ($(date '+%Y-%m-%d %H:%M'))" \
            || echo "Aucune modification √† commit"

          git push
