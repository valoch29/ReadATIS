name: 1_enregistrement_ATIS

on:
  schedule:
    - cron: '22,52 * * * *'
  workflow_dispatch:

jobs:
  record-atis:
    runs-on: ubuntu-22.04
    permissions:
      contents: write  # autorise le push vers le dépôt

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Installer ffmpeg et curl
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y ffmpeg curl

      - name: Enregistrer le flux ATIS en MP3
        run: |
          curl -s -A "Mozilla/5.0" -e "https://www.liveatc.net/" \
          "https://s1-fmt2.liveatc.net/eetn2_atis" \
          | ffmpeg -i pipe:0 -t 120 -y atis_tallinn.mp3

      - name: Convertir MP3 en WAV mono 16kHz
        run: |
          ffmpeg -y -i atis_tallinn.mp3 -ac 1 -ar 16000 atis_tallinn.wav
          ls -lh atis_tallinn.*

      - name: Commit et push du fichier audio
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add atis_tallinn.mp3 atis_tallinn.wav
          git commit -m "Mise à jour de l’audio ATIS ($(date '+%Y-%m-%d %H:%M'))" || echo "Aucune modification à commit"
          git push
