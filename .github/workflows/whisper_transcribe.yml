name: ATIS Transcription Automatique

on:
  schedule:
    - cron: '22,52 * * * *'   # toutes les 30 minutes
  workflow_dispatch:          # d√©clenchement manuel possible

jobs:
  transcribe-atis:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ R√©cup√©rer le d√©p√¥t
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ATIS_TOKEN }}

      # 2Ô∏è‚É£ Installer d√©pendances syst√®me
      - name: Installer d√©pendances syst√®me
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y ffmpeg curl

      # 3Ô∏è‚É£ Installer Whisper
      - name: Installer Whisper
        run: |
          pip install --upgrade pip
          pip install git+https://github.com/openai/whisper.git

      # 4Ô∏è‚É£ Enregistrer le flux ATIS
      - name: Enregistrer le flux ATIS (Tallinn)
        run: |
          echo "üéß T√©l√©chargement du flux LiveATC Tallinn..."
          curl -s -A "Mozilla/5.0" -e "https://www.liveatc.net/" "https://s1-fmt2.liveatc.net/eetn2_atis" | \
          ffmpeg -i pipe:0 -t 120 -y atis_tallinn.mp3
          ls -lh atis_tallinn.mp3

      # 5Ô∏è‚É£ Transcrire l‚Äôaudio avec Whisper (TXT pur)
      - name: Transcrire avec Whisper
        run: |
          echo "üó£Ô∏è Transcription en cours avec Whisper..."
          whisper atis_tallinn.mp3 --model small --language English --output_format txt --output_dir .
          mv atis_tallinn.txt ATIS_tallinn.txt || mv atis_tallinn.*.txt ATIS_tallinn.txt
          echo "‚úÖ Transcription g√©n√©r√©e :"
          head -n 10 ATIS_tallinn.txt

      # 6Ô∏è‚É£ Nettoyer le texte (enlever timestamps si Whisper en met)
      - name: Nettoyer la transcription
        run: |
          if grep -q "\[00:" ATIS_tallinn.txt; then
            echo "‚ö†Ô∏è Suppression des timestamps..."
            sed -E 's/\[[0-9:. -\>]+\]//g' ATIS_tallinn.txt > cleaned.txt
            mv cleaned.txt ATIS_tallinn.txt
          fi

      # 7Ô∏è‚É£ Commit et push le fichier mis √† jour
      - name: Commit et push la transcription
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add ATIS_tallinn.txt
          if ! git diff-index --quiet HEAD; then
            git commit -m "üîÅ Mise √† jour automatique de la transcription ATIS ($(date +'%Y-%m-%d %H:%M:%S'))"
            git push https://valoch29:${{ secrets.ATIS_TOKEN }}@github.com/valoch29/ReadATIS.git HEAD:main
          else
            echo "Aucun changement d√©tect√© ‚Äî pas de commit."
          fi

      # 8Ô∏è‚É£ (Optionnel) Upload artefact pour debug
      - name: Upload du fichier de transcription (debug)
        uses: actions/upload-artifact@v4
        with:
          name: ATIS_tallinn
          path: ATIS_tallinn.txt
