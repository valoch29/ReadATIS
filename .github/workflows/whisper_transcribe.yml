name: Transcription ATIS avec Whisper

on:
  workflow_dispatch:

permissions:
  contents: write   # ✅ permet au workflow de créer/modifier des fichiers dans le repo

jobs:
  transcribe-atis:
    runs-on: ubuntu-22.04

    steps:
      # 1️⃣ Cloner le dépôt
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Installer ffmpeg
      - name: Installer ffmpeg
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y ffmpeg

      # 3️⃣ Configurer Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.12

      # 4️⃣ Installer Whisper
      - name: Installer Whisper
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          pip install git+https://github.com/openai/whisper.git

      # 5️⃣ Vérifier que le fichier audio existe
      - name: Vérifier présence du fichier audio
        run: |
          if [ ! -f "atis_tallinn.wav" ]; then
            echo "❌ Le fichier audio 'atis_tallinn.wav' est introuvable !"
            exit 1
          fi
          ls -lh atis_tallinn.wav

      # 6️⃣ Transcrire avec Whisper
      - name: Transcrire ATIS avec Whisper
        run: |
          source venv/bin/activate
          whisper atis_tallinn.wav --model small --language fr --output_format txt --output_dir .

      # 7️⃣ Lister les fichiers générés
      - name: Lister les fichiers générés
        run: ls -lh

      # 8️⃣ Afficher le résultat dans les logs
      - name: Afficher le résultat
        run: cat atis_tallinn.txt || echo "⚠️ Le fichier atis_tallinn.txt n'a pas été trouvé."

      # 9️⃣ Commit et push du fichier généré
      - name: Configurer Git pour le push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit et push du fichier ATIS_tallinn.txt
        run: |
          if [ -f "atis_tallinn.txt" ]; then
            git add atis_tallinn.txt
            git commit -m "Mise à jour automatique de la transcription ATIS_tallinn.txt" || echo "Aucune modification à valider"
            git push
          else
            echo "⚠️ Fichier 'atis_tallinn.txt' introuvable, rien à pousser."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
