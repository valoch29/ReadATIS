name: 2_transcription

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["record-atis"]
    types:
      - completed

jobs:
  transcribe-atis:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Installer ffmpeg et Python
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y ffmpeg python3 python3-pip git

      # --- CACHE 1 : pip (bibliothèques Python) ---
      - name: Cache pip pour Whisper
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-whisper
          restore-keys: |
            ${{ runner.os }}-pip-

      # --- CACHE 2 : modèles Whisper ---
      - name: Cache du modèle Whisper
        uses: actions/cache@v3
        with:
          path: ~/.cache/whisper
          key: ${{ runner.os }}-whisper-model
          restore-keys: |
            ${{ runner.os }}-whisper

      # Installer Whisper
      - name: Installer Whisper
        run: |
          pip install --upgrade openai-whisper

      # Transcrire ATIS
      - name: Transcrire ATIS avec Whisper (anglais)
        run: |
          whisper atis_tallinn.wav --model small --language en --output_format txt --output_dir .

      # Nettoyer et corriger la transcription
      - name: Corriger et nettoyer la transcription
        run: |
          python3 <<'PYCODE'
          import re
          from datetime import datetime

          input_file = "atis_tallinn.txt"
          output_file = "atis_tallinn.txt"

          with open(input_file, "r", encoding="utf-8") as f:
              text = f.read()

          corrections = {
              r"\blitres?\b": "metres",
              r"\bniner\b": "nine",
              r"\bENT\b": "Echo November Tango",
              r"\bBritish Southern\b": "Tallinn",
              r"\bvisibility (\d+)\s*litres\b": r"visibility \1 metres",
              r"\bQNH\s*0\s*niner\s*niner\s*7\b": "QNH 997",
          }

          for pattern, repl in corrections.items():
              text = re.sub(pattern, repl, text, flags=re.IGNORECASE)

          text = re.sub(r"\s+", " ", text).strip()
          timestamp = datetime.utcnow().strftime("%Y-%m-%d %H:%M UTC")

          with open(output_file, "w", encoding="utf-8") as f:
              f.write(f"ATIS Tallinn transcription ({timestamp}):\n\n{text}\n")

          print("\n--- Transcription nettoyée ---\n")
          print(text)
          PYCODE

      # Commit et push la transcription
      - name: Commit et push la transcription
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          # Ajouter uniquement le fichier texte
          git add atis_tallinn.txt
          git commit -m "Mise à jour transcription ATIS ($(date +'%Y-%m-%d %H:%M'))" || echo "Rien à commit"
          git pull --rebase origin main
          git push origin main
