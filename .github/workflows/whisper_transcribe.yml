name: Transcription ATIS rapide

on:
  workflow_dispatch:

jobs:
  transcribe-atis:
    runs-on: ubuntu-22.04
    permissions:
      contents: write  # nécessaire pour push via GITHUB_TOKEN

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Installer ffmpeg et Python
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y ffmpeg python3 python3-pip git

      - name: Installer Whisper et dépendances (cache pip)
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - run: |
          pip install --upgrade openai-whisper

      - name: Transcrire ATIS avec Whisper (modèle small)
        run: |
          whisper atis_tallinn.wav \
            --model small \
            --language en \
            --output_format txt \
            --output_dir . \
            --verbose

      - name: Nettoyer la transcription
        run: |
          python3 <<'PYCODE'
          import re
          from datetime import datetime

          input_file = "atis_tallinn.txt"
          output_file = "atis_tallinn_clean.txt"

          with open(input_file, "r") as f:
              text = f.read()

          corrections = {
              r"\blitres?\b": "metres",
              r"\bniner\b": "nine",
              r"\bENT\b": "Echo November Tango",
              r"\bBritish Southern\b": "Tallinn",
              r"\bvisibility (\d+)\s*litres\b": r"visibility \1 metres",
              r"\bQNH\s*0\s*niner\s*niner\s*7\b": "QNH 997",
          }
          for pattern, repl in corrections.items():
              text = re.sub(pattern, repl, text, flags=re.IGNORECASE)

          text = re.sub(r"\s+", " ", text).strip()
          timestamp = datetime.utcnow().strftime("%Y-%m-%d %H:%M UTC")
          with open(output_file, "w") as f:
              f.write(f"ATIS Tallinn transcription ({timestamp}):\n\n{text}\n")

          print("\n--- Transcription nettoyée ---\n")
          print(text)
          PYCODE

      - name: Commit et push la transcription
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add atis_tallinn_clean.txt
          git commit -m "Mise à jour transcription ATIS ($(date +'%Y-%m-%d %H:%M'))" || echo "Rien à commit"
          git remote set-url origin https://${GITHUB_ACTOR}:${GITHUB_TOKEN}@github.com/valoch29/ReadATIS.git
          git push origin main
